<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Узнаешь?</title>
    <style>
        body {
            background-color: #000;
            color: #00ffcc;
            font-family: monospace;
            padding: 40px;
        }

        .terminal-line {
            margin-bottom: 1em;
            white-space: pre-wrap;
        }

        button {
            background-color: #00ffcc;
            color: #000;
            border: none;
            padding: 8px 12px;
            margin-top: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        #question.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #question {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="dialogue"></div>
    <div id="user-list" class="hidden"></div>

    <div id="question" class="hidden">
        <p>Ты узнаёшь их?</p>
        <button onclick="answer(true)">Да</button>
        <button onclick="answer(false)">Нет</button>
    </div>

    <div id="post-question" class="hidden">
        <p id="answer-text"></p>
        <div class="terminal-line">Тем не менее вас всех что-то объединяет...</div>
        <div class="terminal-line">Ух... не пейте кофе...</div>
        <div class="terminal-line">Я пройдусь по каждому из вас</div>
        <div class="terminal-line">Вы вместе пройдётесь по всему пути</div>
        <div class="terminal-line">Выявим вместе... кто вы</div>
        <button onclick="markReady()">Продолжить</button>
    </div>

    <div id="waiting" class="hidden">
        <p>Ожидание остальных участников...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5MNPm3OX_041RI5HV_Cit63KEhGwEltc",
            authDomain: "ogtis-e2e4b.firebaseapp.com",
            projectId: "ogtis-e2e4b",
            storageBucket: "ogtis-e2e4b.appspot.com",
            messagingSenderId: "8188688236",
            appId: "1:8188688236:web:ca6e4cf0e707a4ac9e6549",
            databaseURL: "https://ogtis-e2e4b-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const nickname = new URLSearchParams(window.location.search).get("nickname") || "???";

        const userListElement = document.getElementById("user-list");
        const questionElement = document.getElementById("question");
        const postQuestionElement = document.getElementById("post-question");
        const waitingElement = document.getElementById("waiting");

        function addLineAnimated(html) {
            return new Promise(resolve => {
                const line = document.createElement("div");
                line.className = "terminal-line";
                userListElement.appendChild(line);

                let i = 0;
                const text = html;
                const interval = setInterval(() => {
                    line.innerHTML = text.slice(0, i) + (i % 2 === 0 ? "_" : "");
                    i++;
                    if (i > text.length) {
                        clearInterval(interval);
                        line.innerHTML = text;
                        resolve();
                    }
                }, 30);
            });
        }

        const usersRef = ref(db, 'users');
        onValue(usersRef, async (snapshot) => {
            if (snapshot.exists()) {
                const users = snapshot.val();
                const others = Object.values(users)
                    .map(user => user.nickname)
                    .filter(name => name !== nickname);

                userListElement.innerHTML = "";
                questionElement.classList.add("hidden");

                if (others.length > 0) {
                    const lines = [
                        `<strong>${nickname}</strong>, смотри, кто-то ещё зашёл:`,
                        ...others.map(name => `    ${name}`),
                        "Ты узнаёшь их?"
                    ];
                    for (const line of lines) {
                        await addLineAnimated(line);
                    }
                    questionElement.classList.remove("hidden");
                } else {
                    await addLineAnimated(`Ты пока здесь один, <strong>${nickname}</strong>...`);
                    await addLineAnimated(`Ожидаем других участников...`);
                }

                userListElement.classList.remove("hidden");
            }
        });

        function answer(recognize) {
            questionElement.classList.add('hidden');
            postQuestionElement.classList.remove('hidden');
            const answerText = recognize
                ? "А я... тяжело... надо пройтись по каждому..."
                : "Я тоже... мне нужно больше данных...";
            document.getElementById("answer-text").innerText = answerText;
        }

        function markReady() {
            postQuestionElement.classList.add('hidden');
            waitingElement.classList.remove('hidden');

            const userKeyRef = ref(db, 'ready/' + encodeURIComponent(nickname));
            set(userKeyRef, true);

            onValue(ref(db, 'ready'), snapshot => {
                const totalUsers = document.querySelectorAll("#user-list li").length + 1;
                const readyUsers = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;

                if (readyUsers >= totalUsers) {
                    window.location.href = `stage1.html?nickname=${encodeURIComponent(nickname)}`;
                }
            });
        }
    </script>
</body>
</html>